# 代码模块管理规则

> **版本**: 1.5.0  
> **最后更新**: 2026-01-26

## 💻 代码模块管理规则

**强制规则：任何时候都不能创建重复的代码模块、函数或工具类。如果发现已有相关功能，必须复用现有代码，而不是创建新代码。**

### 代码创建前检查

在创建任何代码模块、函数或工具类之前，必须：

1. **搜索现有代码**：
   - 使用 `codebase_search` 或 `grep` 搜索相关功能的实现
   - 检查 `src/` 目录下的所有子目录
   - 检查是否有相似功能的函数、类或模块
   - 检查工具函数、工具类、辅助模块

2. **识别重复功能**：
   - 如果发现功能相似的代码，必须复用现有代码
   - 如果现有代码需要扩展，优先扩展而不是创建新的
   - 如果现有代码设计不合理，先重构再复用

3. **代码复用原则**：
   - 优先使用现有函数/类
   - 通过参数扩展功能，而不是复制代码
   - 创建通用的工具函数，避免重复实现
   - 使用组合而不是重复

### 代码模块更新流程

1. **发现需要创建代码时**：
   - 先搜索是否已有相关实现
   - 如果有，复用或扩展现有代码
   - 如果没有，创建新代码，但要考虑通用性

2. **发现重复代码时**：
   - 识别最佳实现（最通用、最清晰、最符合架构）
   - 将其他地方的调用迁移到最佳实现
   - 删除重复代码
   - 更新相关引用

3. **代码模块检查清单**：
   - [ ] 已搜索现有代码
   - [ ] 已识别可复用的代码
   - [ ] 已复用或扩展现有代码
   - [ ] 已删除重复代码
   - [ ] 已更新所有引用
   - [ ] 代码符合架构设计

### 常见重复场景

1. **工具函数重复**：
   - 文件路径处理（`path.join`, `path.basename` 等）
   - 时间格式化
   - 数据验证
   - 错误处理包装

2. **类型定义重复**：
   - 接口定义
   - 枚举类型
   - 类型别名

3. **业务逻辑重复**：
   - 状态管理逻辑
   - 数据处理逻辑
   - 事件处理逻辑

### 示例

**错误做法**：
```typescript
// 文件1: utils/formatTime.ts
export function formatTime(seconds: number): string { ... }

// 文件2: helpers/timeHelper.ts 
export function formatDuration(seconds: number): string { ... } // 重复实现

// 文件3: components/TimeDisplay.ts
function formatSeconds(seconds: number): string { ... } // 又重复实现
```

**正确做法**：
```typescript
// 统一工具文件: utils/timeUtils.ts
export function formatTime(seconds: number): string { ... }

// 其他地方都导入使用
import { formatTime } from '@/utils/timeUtils'
```

### 代码重构原则

当发现重复代码时：

1. **提取公共部分**：
   - 创建通用函数/类
   - 将差异部分作为参数
   - 保持向后兼容

2. **渐进式重构**：
   - 先创建通用实现
   - 逐步迁移调用方
   - 最后删除旧代码

3. **保持架构一致性**：
   - 遵循项目架构（Domain/Application/Infrastructure）
   - 保持代码风格一致
   - 更新相关文档
