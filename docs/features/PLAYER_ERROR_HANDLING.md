## 播放错误体验与诊断能力升级

> 状态：进行中 / 可用  
> 版本范围：mpv-player （native libmpv 集成阶段）

---

### 1. 功能概述（从产品角度）

在旧版本中，当 mpv 播放出错（如无法识别文件格式、文件损坏、网络异常等）时：

- 前端只能感知到「播放失败」，缺少**明确的错误原因**；
- 用户只能在控制台/终端中看到原始 mpv 日志，不利于**非技术用户排查问题**；
- 产品层面缺少统一的「错误页」体验。

本次升级的目标是：

- 在播放器 UI 中增加**统一的错误展示体验**；
- 针对常见错误给出**友好的提示文案**（本地化 + 面向普通用户）；
- 为高级用户和开发者提供**可选的技术详情**（mpv 原始错误 log 片段），便于快速诊断。

---

### 2. 用户视角下的行为变化

#### 2.1 当播放失败（例如无法识别文件格式）时

用户将看到：

- 一个明确的「播放出错」界面，而不是黑屏或静默失败；
- 一条面向用户的错误信息，例如：
  - 「无法识别媒体格式，当前文件可能不是有效的视频或音频。」
- 在需要时，用户/开发者可以展开「查看技术详情」，看到来自 mpv 的原始错误信息：
  - 例如：`[mpv:error:cplayer] Failed to recognize file format.` 以及最近几行相关日志。

#### 2.2 对交互的影响

- 出错后，播放器不会继续尝试播放该文件，用户可以：
  - 关闭错误页返回媒体列表；
  - 或选择重新播放 / 加载其它文件（由后续交互设计决定）。
- 对正常播放路径（成功播放、暂停、seek 等）**没有负面影响**。

---

### 3. 对产品的价值

- **可用性提升**：
  - 非技术用户也能理解「为什么播放不了」，而不是只看到一个失败状态或黑屏；
  - 对于网络/格式问题，可以在文案中提供简单的建议（例如「请检查文件是否为支持的媒体格式」）。

- **诊断效率提升**：
  - 开发/运维人员无需再手动打开终端抓 mpv 输出，在 UI 中即可看到最近的 mpv 错误日志；
  - 配合现有的日志系统，可以快速定位「是文件问题、解码问题还是渲染配置问题」。

- **一致的错误体验**：
  - 不同类型的播放错误（无法识别格式、文件不存在、权限问题等）都通过统一入口展示；
  - 便于后续在产品层面统一风格、文案和可操作建议（例如「重试」「重新选择文件」）。

---

### 4. 技术简要说明（面向产品/PM）

（技术细节完整版本参见：`docs/development/MPV_ERROR_PROPAGATION.md`）

- **底层采集**：
  - native libmpv 通过事件回调输出 log（包括 `[mpv:error:cplayer] ...`），后台会记录最近的错误和一段日志片段。

- **错误语义提炼**：
  - 后台从 mpv 的原始错误文本中提炼出「用户可理解」的错误信息；
  - 例如，将 `Failed to recognize file format` 映射为中文提示「无法识别媒体格式……」。

- **状态流传递**：
  - 这些错误信息会随着播放器状态一起传递到前端（`player-state` 消息），前端可以据此渲染错误页。

- **前端展示**：
  - UI 组件根据状态中的 `phase === 'error'` 和 `error` 字段决定是否展示错误页；
  - 同时提供一个入口展示 mpv 原始日志片段（可折叠）。

---

### 5. 后续扩展方向

- **更多错误场景覆盖**：
  - 针对网络错误（超时、DNS 失败）、权限问题（无权访问文件）等，补充对应的用户文案。

- **错误恢复操作**：
  - 在错误页中提供「重试」「打开日志文件位置」「反馈问题」等操作。

- **国际化支持**：
  - 将用户提示文案纳入 i18n 体系，根据系统语言展示对应语言版本。

