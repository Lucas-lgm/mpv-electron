# NAS 资源访问使用指南

## 📋 概述

本应用支持通过 SMB/CIFS 协议访问 NAS（网络附加存储）上的视频资源。在 macOS 上，需要先通过系统挂载 SMB 共享，然后应用才能扫描和播放 NAS 上的视频文件。

## 🚀 快速开始

### 步骤 1：添加 NAS 连接

1. 在应用侧边栏找到 **"NAS 连接"** 区域
2. 点击 **"添加 NAS"** 按钮
3. 填写 NAS 连接信息：
   - **连接名称**：给这个连接起个名字（例如："家庭 NAS"）
   - **主机地址**：NAS 的 IP 地址或域名（例如：`192.168.1.100` 或 `nas.example.com`）
   - **共享名称**：SMB 共享的名称（例如：`Movies`）
   - **路径**（可选）：共享内的子路径（例如：`/Videos/Movies`）
   - **端口**（可选）：SMB 端口，默认 445
   - **用户名**（可选）：如果需要认证
   - **密码**（可选）：如果需要认证（会加密存储）
4. 点击 **"测试连接"** 验证配置是否正确
5. 点击 **"确定"** 保存连接

### 步骤 2：挂载 SMB 共享（macOS）

在 macOS 上，需要先通过系统挂载 SMB 共享，应用才能访问其中的文件。

#### 方法 1：通过 Finder 挂载（推荐）

1. 打开 **Finder**
2. 按 `⌘ + K`（或菜单栏：前往 → 连接服务器）
3. 输入 SMB 地址：`smb://[主机地址]/[共享名称]`
   - 例如：`smb://192.168.1.100/Movies`
   - 如果需要认证，格式为：`smb://[用户名]:[密码]@[主机地址]/[共享名称]`
4. 点击 **"连接"**
5. 如果需要认证，输入用户名和密码
6. 挂载成功后，共享会出现在 Finder 侧边栏和 `/Volumes/` 目录下

#### 方法 2：通过命令行挂载

```bash
# 基本挂载命令
mount_smbfs //[用户名]@[主机地址]/[共享名称] /Volumes/[挂载点名称]

# 示例（需要密码时会提示输入）
mount_smbfs //admin@192.168.1.100/Movies /Volumes/NAS-Movies

# 带密码的挂载（不推荐，密码会出现在命令历史中）
mount_smbfs //admin:password@192.168.1.100/Movies /Volumes/NAS-Movies
```

**注意**：
- 挂载点名称可以自定义，但建议使用共享名称，这样应用更容易识别
- 挂载后，共享会出现在 `/Volumes/` 目录下

### 步骤 3：扫描 NAS 资源

1. 确保 SMB 共享已成功挂载（在 Finder 中可以看到）
2. 在应用侧边栏的 **"NAS 连接"** 区域，找到你添加的 NAS 连接
3. 点击连接项右侧的 **🔄 刷新按钮** 开始扫描
4. 等待扫描完成（扫描时间取决于文件数量和网络速度）
5. 扫描完成后，连接状态会显示为 **✓ 已连接**，并显示找到的资源数量

### 步骤 4：查看和播放资源

1. 扫描完成后，NAS 上的视频文件会自动添加到媒体库
2. 在侧边栏点击 **"NAS 存储"** 筛选器，查看所有 NAS 资源
3. 或者点击具体的 NAS 连接项，查看该连接下的资源
4. 点击视频卡片即可播放

## 🔍 常见问题

### Q1: 扫描时提示 "SMB 共享未挂载"

**原因**：SMB 共享还没有通过系统挂载。

**解决方法**：
1. 按照步骤 2 先挂载 SMB 共享
2. 确认挂载成功：在 Finder 侧边栏或 `/Volumes/` 目录下可以看到共享
3. 再次点击刷新按钮扫描

### Q2: 扫描时提示 "路径不存在"

**原因**：配置的路径在共享中不存在。

**解决方法**：
1. 检查 NAS 配置中的 **"路径"** 字段是否正确
2. 如果路径为空，确保共享根目录下有视频文件
3. 如果路径不为空，确保该路径在共享中存在

### Q3: 播放 NAS 视频时无法播放

**原因**：可能是路径转换问题或网络问题。

**解决方法**：
1. 确保 SMB 共享仍然挂载（未断开）
2. 检查网络连接是否正常
3. 尝试重新扫描 NAS 连接
4. 检查视频文件是否损坏

### Q4: 如何自动挂载 NAS？

**方法 1：使用 macOS 的自动挂载功能**

1. 在 Finder 中挂载 NAS 后，打开 **系统设置** → **通用** → **登录项**
2. 将挂载的 NAS 添加到登录项，系统启动时会自动挂载

**方法 2：使用脚本自动挂载**

创建一个 shell 脚本，在系统启动时自动挂载：

```bash
#!/bin/bash
# 保存为 ~/mount-nas.sh

mount_smbfs //username@192.168.1.100/Movies /Volumes/NAS-Movies
```

然后添加到登录项或使用 `launchd` 配置自动运行。

### Q5: 密码安全吗？

**是的**，密码使用 Electron 的 `safeStorage` API 加密存储：
- 密码在存储前会被加密
- 加密后的密码以 base64 编码形式保存
- 只有当前用户可以使用系统密钥解密
- 密码不会以明文形式出现在配置文件中

### Q6: 支持哪些 NAS 协议？

目前支持：
- ✅ **SMB/CIFS**（Windows 文件共享协议）

未来可能支持：
- NFS（网络文件系统）
- FTP/SFTP

## 📝 技术说明

### 路径转换机制

应用会自动处理路径转换：

1. **扫描时**：应用会检查 `/Volumes/[共享名称]` 下的挂载点
2. **播放时**：应用会将挂载点路径转换为 SMB 协议路径
   - 挂载点路径：`/Volumes/Movies/video.mp4`
   - 转换为：`smb://192.168.1.100/Movies/video.mp4`
3. **MPV 播放**：MPV 通过 FFmpeg 支持 SMB 协议，可以直接播放 `smb://` 路径

### 扫描机制

- 扫描深度：默认最多扫描 5 层目录
- 文件识别：通过文件扩展名和文件头（Magic Bytes）识别视频文件
- 性能优化：跳过已知的非视频文件类型，提高扫描速度

### 连接状态

NAS 连接有三种状态：
- **已连接**（✓）：成功扫描到资源
- **未连接**：SMB 共享未挂载
- **错误**（⚠️）：扫描时发生错误，查看错误信息了解详情

## 🛠️ 高级用法

### 使用命令行挂载（带认证）

```bash
# 创建挂载点目录
mkdir -p /Volumes/NAS-Movies

# 挂载（会提示输入密码）
mount_smbfs //username@192.168.1.100/Movies /Volumes/NAS-Movies

# 卸载
umount /Volumes/NAS-Movies
```

### 检查挂载状态

```bash
# 查看所有挂载的 SMB 共享
mount | grep smbfs

# 查看 /Volumes 目录下的挂载点
ls -la /Volumes/
```

### 配置文件位置

NAS 连接配置保存在：
```
~/Library/Application Support/mpv-player/nas-connections.json
```

**注意**：不要手动编辑此文件，密码已加密存储。

## 📚 相关文档

- [架构文档](./ARCHITECTURE.md) - 了解 NAS 服务的实现细节
- [IPC 通信设计](./ARCHITECTURE.md#5-ipc通信设计) - 了解 NAS 相关的 IPC 消息

## 💡 提示

1. **保持挂载**：播放 NAS 视频时，确保 SMB 共享保持挂载状态
2. **网络稳定**：NAS 播放需要稳定的网络连接，建议使用有线网络
3. **定期刷新**：如果 NAS 上添加了新视频，点击刷新按钮重新扫描
4. **多个共享**：可以为同一个 NAS 的不同共享创建多个连接配置
