# 调试步骤：修复 MPV 嵌入问题

## 当前问题

从日志看，MPV 接受了 `--wid` 参数，但视频仍在独立窗口中播放。这说明：
- ✅ 代码逻辑正常（成功获取了窗口指针）
- ⚠️ MPV 可能需要 **NSView（contentView）** 而不是 **NSWindow** 指针

## 修复方案

我已经实现了完整的 `getContentViewPointer` 函数，它会：
1. 编译一个 Objective-C 程序
2. 从 NSWindow 获取 contentView
3. 返回 NSView 指针给 MPV

## 测试步骤

### 1. 重新运行应用

```bash
npm run dev
```

### 2. 观察日志输出

现在应该看到这些日志：

**成功的情况（获取到 contentView）：**
```
[NativeHelper] NSWindow pointer: 1151077751296
[NativeHelper] Attempting to get contentView from NSWindow...
[NativeHelper] Created temporary Objective-C file: /tmp/...
[NativeHelper] Compilation successful, running binary...
[NativeHelper] Successfully got contentView pointer: 1234567890
[NativeHelper] ✅ Successfully got ContentView pointer: 1234567890
[NativeHelper] Using ContentView for MPV embedding
[MPVController] Embedding into window with ID: 1234567890
```

**失败的情况（会回退到 NSWindow）：**
```
[NativeHelper] ⚠️ Failed to get ContentView, using NSWindow pointer as fallback
[NativeHelper] Note: MPV typically requires NSView (contentView), not NSWindow
```

### 3. 检查编译是否成功

如果看到编译错误，可能是：
- 缺少 clang 编译器（通常 macOS 自带）
- 权限问题

### 4. 检查 MPV 启动参数

查看日志中的 MPV 启动参数：

```
Starting mpv with args: [
  ...
  '--wid=1234567890',  // ← 这个应该是 contentView 指针
  ...
]
```

### 5. 观察视频窗口

- ✅ **成功**：视频显示在 Electron 窗口中
- ⚠️ **失败**：MPV 仍然创建独立窗口

## 可能的问题

### 问题 1：编译失败

**症状：**
```
[NativeHelper] Compilation failed: ...
```

**解决：**
- 确保系统安装了 Xcode Command Line Tools
- 运行：`xcode-select --install`

### 问题 2：运行时错误

**症状：**
```
[NativeHelper] Runtime error: ERROR: Window is nil
或
[NativeHelper] Runtime error: ERROR: ContentView is nil
```

**原因：**
- 窗口指针无效
- 窗口还未准备好

**解决：**
- 增加等待时间（在 mpvManager.ts 中）
- 确保窗口已经完全加载

### 问题 3：MPV 仍然创建独立窗口

**可能原因：**
1. MPV 版本不支持 macOS 嵌入
2. NSView 指针格式不对
3. MPV 需要其他参数

**调试方法：**
```bash
# 检查 MPV 版本
mpv --version

# 查看 MPV 文档关于 --wid 的说明
man mpv
```

### 问题 4：权限问题

**症状：**
- 临时文件无法创建或删除
- 编译失败

**解决：**
- 检查 `/tmp` 目录权限
- 检查应用权限（如果是打包后的应用）

## 手动测试 contentView 获取

如果自动获取失败，可以手动测试：

1. **创建一个测试脚本** (`test_get_view.m`):
```objc
#import <Cocoa/Cocoa.h>

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        // 替换为实际的 NSWindow 指针（从日志中获取）
        NSWindow* window = (NSWindow*)1151077751296;
        
        if (window == nil) {
            fprintf(stderr, "ERROR: Window is nil\n");
            return 1;
        }
        
        NSView* contentView = [window contentView];
        
        if (contentView == nil) {
            fprintf(stderr, "ERROR: ContentView is nil\n");
            return 1;
        }
        
        printf("%llu\n", (unsigned long long)contentView);
        return 0;
    }
}
```

2. **编译并运行**:
```bash
clang -framework Cocoa -o test_get_view test_get_view.m
./test_get_view
```

3. **使用输出的指针测试 MPV**:
```bash
mpv --wid=<输出的指针> test.mp4
```

## 下一步

1. **运行应用并观察日志**
2. **如果获取到 contentView，但 MPV 仍然创建独立窗口**：
   - 检查 MPV 版本和文档
   - 可能需要其他参数或配置

3. **如果获取 contentView 失败**：
   - 检查编译错误
   - 检查权限问题
   - 可以尝试其他方法

## 备选方案

如果嵌入一直不工作，可以考虑：

1. **透明窗口同步方案**（方案 C）
   - 更简单，不需要获取 NSView
   - 两个窗口同步位置

2. **使用其他视频播放库**
   - 例如使用 Electron 的 video 标签 + MediaSource API
   - 但功能和性能可能不如 MPV

告诉我测试结果，我们可以根据实际情况调整！
